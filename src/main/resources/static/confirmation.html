<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EventBooking — Booking Confirmed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
            --secondary-gradient: linear-gradient(135deg, #0f172a, #1e293b);
            --accent-color: #6366f1;
            --success-color: #10b981;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .success-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }

        .ticket-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .confirmation-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ticket {
            display: grid;
            grid-template-columns: 2fr 1fr;
            background: var(--secondary-gradient);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .ticket::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 33.333%;
            width: 30px;
            height: 30px;
            background: #0f172a;
            border-radius: 50%;
            transform: translateY(-50%);
            z-index: 2;
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .ticket-left {
            padding: 3rem;
            background: var(--primary-gradient);
            position: relative;
            overflow: hidden;
        }

        .ticket-left::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.03)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .ticket-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .ticket-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .ticket-field {
            margin-bottom: 1.5rem;
        }

        .field-label {
            font-weight: 700;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .field-value {
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
            line-height: 1.4;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .field-value.large {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .ticket-right {
            background: linear-gradient(135deg, #1e293b, #111827);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 3rem 2rem;
            position: relative;
        }

        .qr-container {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            border-radius: 8px;
        }

        .booking-id-display {
            text-align: center;
            margin-bottom: 2rem;
        }

        .booking-id-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .booking-id-value {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-color);
            background: rgba(99, 102, 241, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .btn-download {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
        }

        .btn-download:active {
            transform: translateY(0);
        }

        .btn-download::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-download:hover::before {
            left: 100%;
        }

        .footer-info {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .important-note {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 2rem;
            color: #fbbf24;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .loading-state {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .error-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .ticket {
                grid-template-columns: 1fr;
                max-width: 500px;
                margin: 0 auto;
            }

            .ticket::before {
                display: none;
            }

            .ticket-left, .ticket-right {
                padding: 2rem;
            }

            .ticket-title {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .ticket-container {
                box-shadow: none !important;
            }
        }
    </style>
</head>

<body>
<div id="vanta-bg" class="fixed inset-0 -z-10"></div>

<header class="fixed top-5 left-0 right-0 z-40 px-6">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
        <a href="index.html" class="text-2xl font-extrabold" style="background-image:linear-gradient(90deg,#6366f1,#ec4899); -webkit-background-clip:text; color:transparent">
            🎟 EventBooking
        </a>
        <a href="index.html" class="glass px-4 py-2 rounded-lg transition-all hover:bg-white/10">
            Back to Home
        </a>
    </div>
</header>

<main class="pt-24 min-h-screen">
    <!-- Loading State -->
    <div id="loading" class="loading-state">
        <div class="loading-spinner"></div>
        <h2 class="text-xl font-semibold mb-2">Loading your ticket...</h2>
        <p class="text-gray-400">Please wait while we prepare your confirmation</p>
    </div>

    <!-- Error State -->
    <div id="error" class="error-state">
        <div class="error-icon">⚠️</div>
        <h2 class="text-2xl font-bold mb-2 text-red-400">Booking Not Found</h2>
        <p class="text-gray-400 mb-4">We couldn't find your booking information.</p>
        <a href="index.html" class="btn-secondary">Go Back Home</a>
    </div>

    <!-- Success State -->
    <div id="success" class="ticket-container" style="display: none;">
        <div class="confirmation-header" data-aos="fade-up">
            <div class="success-icon">✅</div>
            <h1 class="text-4xl font-bold mb-2">Booking Confirmed!</h1>
            <p class="text-xl text-gray-300">Your tickets have been successfully booked</p>
        </div>

        <div class="ticket glass" id="ticketDiv" data-aos="fade-up" data-aos-delay="200">
            <div class="ticket-left">
                <div class="ticket-header">
                    <div class="ticket-title">🎫 EVENT TICKET</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Event Name</div>
                    <div id="event-name" class="field-value large">Loading...</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Date & Time</div>
                    <div id="event-date" class="field-value">Loading...</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Venue</div>
                    <div id="event-location" class="field-value">Loading...</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Seat Numbers</div>
                    <div id="ticket-seats" class="field-value">Loading...</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Ticket Holder</div>
                    <div id="ticket-email" class="field-value">Loading...</div>
                </div>

                <div class="ticket-field">
                    <div class="field-label">Total Amount</div>
                    <div id="total-amount" class="field-value">₹0</div>
                </div>
            </div>

            <div class="ticket-right">
                <div class="booking-id-display">
                    <div class="booking-id-label">Booking ID</div>
                    <div id="booking-id" class="booking-id-value">Loading...</div>
                </div>

                <div class="qr-container">
                    <img id="qr-ticket" src="" alt="QR Code" class="qr-code">
                </div>

                <button id="downloadBtn" class="btn-download">
                    📄 Download PDF
                </button>
            </div>
        </div>

        <div class="important-note" data-aos="fade-up" data-aos-delay="400">
            <h3 class="font-semibold mb-2">📱 Important Instructions:</h3>
            <ul class="text-sm space-y-1">
                <li>• Please arrive 30 minutes before the event starts</li>
                <li>• Show this QR code or PDF at the venue entrance</li>
                <li>• Keep your booking ID handy for any queries</li>
                <li>• Contact support if you face any issues</li>
            </ul>
        </div>

        <div class="action-buttons" data-aos="fade-up" data-aos-delay="500">
            <a href="index.html" class="btn-secondary">🏠 Back to Home</a>
            <button onclick="window.print()" class="btn-secondary">🖨️ Print Ticket</button>
            <button id="shareBtn" class="btn-secondary">📤 Share</button>
        </div>
    </div>
</main>

<footer class="footer-info">
    <p>&copy; 2025 EventBooking. All rights reserved.</p>
    <p>For support, contact: support@eventbooking.com</p>
</footer>

<script>
    // Initialize Vanta background
    VANTA.NET({
        el: "#vanta-bg",
        color: 0x6366f1,
        backgroundColor: 0x0f172a,
        points: 0.0,
        maxDistance: 0.0,
        spacing: 20.0
    });

    // Initialize AOS
    document.addEventListener('DOMContentLoaded', () => {
        AOS.init({ duration: 800, once: true });
        loadBookingData(); // Call after function is defined
    });


    function showLoading() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
    }

    function showError() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('success').style.display = 'none';
    }

    function showSuccess() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'block';
    }

    function formatDateTime(dateString) {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return "Date & Time TBD";
            }

            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            };

            return date.toLocaleDateString('en-IN', options);
        } catch (error) {
            console.error('Error formatting date:', error);
            return "Date & Time TBD";
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0
        }).format(amount || 0);
    }

    async function loadBookingData() {
        showLoading();

        try {
            // Simulate loading delay for better UX
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Try multiple sources for booking data
            let booking = null;

            // First, try sessionStorage (most recent)
            const sessionBooking = sessionStorage.getItem('booking');
            if (sessionBooking) {
                booking = JSON.parse(sessionBooking);
            }

            // Fallback to localStorage
            if (!booking) {
                const localBooking = localStorage.getItem('booking');
                if (localBooking) {
                    booking = JSON.parse(localBooking);
                }
            }

            // Check URL parameters as another fallback
            if (!booking) {
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('booking');
                if (bookingId) {
                    // Try to fetch booking data from server
                    try {
                        const response = await fetch(`/api/bookings/${bookingId}`);
                        if (response.ok) {
                            booking = await response.json();
                        }
                    } catch (err) {
                        console.error('Failed to fetch booking:', err);
                    }
                }
            }

            if (!booking || Object.keys(booking).length === 0) {
                throw new Error('No booking data found');
            }

            // Populate the ticket with booking data
            populateTicket(booking);
            showSuccess();

        } catch (error) {
            console.error('Error loading booking data:', error);
            showError();
        }
    }

    function populateTicket(booking) {
        // Basic information
        document.getElementById('booking-id').textContent = booking.id || booking.bookingId || generateBookingId();
        document.getElementById('event-name').textContent = booking.eventName || booking.event?.name || 'Event Name';
        document.getElementById('event-location').textContent = booking.eventLocation || booking.event?.location || booking.venue || 'Venue TBD';
        document.getElementById('ticket-email').textContent = booking.userEmail || booking.email || 'user@example.com';

        // Format date properly
        const eventDate = booking.eventDate || booking.event?.date || booking.date;
        document.getElementById('event-date').textContent = formatDateTime(eventDate);

        // Handle seats (can be array or string)
        let seats = booking.seats || booking.selectedSeats || [];
        if (typeof seats === 'string') {
            try {
                seats = JSON.parse(seats);
            } catch {
                seats = [seats];
            }
        }
        if (!Array.isArray(seats)) {
            seats = [seats].filter(Boolean);
        }
        document.getElementById('ticket-seats').textContent = seats.length > 0 ? seats.join(', ') : 'General Admission';

        // Handle amount
        const amount = booking.totalAmount || booking.amount || booking.total || 0;
        document.getElementById('total-amount').textContent = formatCurrency(amount);

        // Generate QR code with comprehensive booking data
        const qrData = encodeURIComponent(JSON.stringify({
            id: booking.id || booking.bookingId,
            event: booking.eventName || booking.event?.name,
            seats: seats,
            date: eventDate,
            email: booking.userEmail || booking.email
        }));

        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${qrData}&bgcolor=FFFFFF&color=000000&margin=10`;
        document.getElementById('qr-ticket').src = qrUrl;

        // Store the booking data globally for PDF generation
        window.currentBooking = booking;
    }

    function generateBookingId() {
        return 'BK' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
    }

    // PDF Download functionality
    document.getElementById('downloadBtn').addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;

        try {
            button.innerHTML = '⏳ Generating PDF...';
            button.disabled = true;

            // Hide interactive elements for PDF
            const interactiveElements = document.querySelectorAll('.btn-download, .action-buttons, header');
            interactiveElements.forEach(el => el.style.display = 'none');

            // Generate high-quality canvas
            const ticketDiv = document.getElementById('ticketDiv');
            const canvas = await html2canvas(ticketDiv, {
                scale: 2,
                backgroundColor: null,
                useCORS: true,
                allowTaint: true,
                logging: false,
                width: ticketDiv.offsetWidth,
                height: ticketDiv.offsetHeight
            });

            // Restore interactive elements
            interactiveElements.forEach(el => el.style.display = '');

            // Create PDF
            const { jsPDF } = window.jspdf;
            const imgData = canvas.toDataURL('image/png', 1.0);

            // Calculate dimensions for A4 landscape
            const pdfWidth = 297; // A4 width in mm
            const pdfHeight = 210; // A4 height in mm
            const imgAspectRatio = canvas.width / canvas.height;
            const pdfAspectRatio = pdfWidth / pdfHeight;

            let finalWidth, finalHeight;
            if (imgAspectRatio > pdfAspectRatio) {
                finalWidth = pdfWidth - 20; // 10mm margin on each side
                finalHeight = finalWidth / imgAspectRatio;
            } else {
                finalHeight = pdfHeight - 20; // 10mm margin on top/bottom
                finalWidth = finalHeight * imgAspectRatio;
            }

            const x = (pdfWidth - finalWidth) / 2;
            const y = (pdfHeight - finalHeight) / 2;

            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            // Add the ticket image
            pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);

            // Add footer text
            pdf.setFontSize(8);
            pdf.setTextColor(128, 128, 128);
            pdf.text('Generated by EventBooking - Keep this ticket safe', pdfWidth / 2, pdfHeight - 5, { align: 'center' });

            // Generate filename
            const booking = window.currentBooking || {};
            const eventName = (booking.eventName || 'Event').replace(/[^a-z0-9]/gi, '_');
            const bookingId = booking.id || booking.bookingId || 'ticket';
            const filename = `EventBooking_${eventName}_${bookingId}.pdf`;

            // Download
            pdf.save(filename);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Failed to generate PDF. Please try again.');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });

    // Share functionality
    document.getElementById('shareBtn').addEventListener('click', async function() {
        const booking = window.currentBooking || {};
        const shareData = {
            title: 'My Event Ticket',
            text: `I booked tickets for ${booking.eventName || 'an event'}! 🎟️`,
            url: window.location.href
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                alert('Booking details copied to clipboard!');
            }
        } catch (error) {
            console.error('Error sharing:', error);
            // Final fallback: show share modal or copy text
            const text = `Check out my ticket for ${booking.eventName || 'this event'}!\nBooking ID: ${booking.id || 'N/A'}\n${window.location.href}`;
            try {
                await navigator.clipboard.writeText(text);
                alert('Booking details copied to clipboard!');
            } catch {
                prompt('Copy this text to share:', text);
            }
        }
    });

    // Auto-cleanup old booking data
    setTimeout(() => {
        sessionStorage.removeItem('booking');
    }, 300000); // 5 minutes
</script>

</body>
</html>